---
title: "CFA"
author: ""
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE, tidy = TRUE)
```

Load packages
```{r}
library(MplusAutomation)
library(tidyverse)
library(here)
library(semPlot)
library(DiagrammeR)
library(gtsummary)
library(gt)
```

## Load data example 

DATA SOURCE: This lab exercise utilizes the NCES public-use dataset: Education Longitudinal Study of 2002 (Lauff & Ingels, 2014) [$\color{blue}{\text{See website: nces.ed.gov}}$](https://nces.ed.gov/surveys/els2002/avail_data.asp)
```{r}
# Note (Josh): These data subsets can be stored in a designated Git repository & then accessed as a link

cfa_data <- read_csv("https://garberadamc.github.io/project-site/data/els_sub5_data.csv")

```

## Prepare `data.frame` for analysis (select & reorder columns)
```{r}

# Note (Josh): A question of style is how much we emphasize the specific applied example.
# For example in details like naming of objects (i.e., "school_trouble"). 
# Depends on primary learning objective & audience I guess.

school_trouble <- cfa_data %>% 
  select(stolen, t_hurt, p_fight, hit, damaged, bullied,  # factor 1 (indicators)
         safe, disrupt, gangs, rac_fght)                  # factor 2 (indicators)

```

## Look at variables for CFA example
```{r, echo=FALSE}
# CODE HIDDEN
tribble(
~"Name", ~" Variable Description", 
#----------|-------------|,
"stolen"   , "Had something stolen at school"                   ,
"t_hurt"   , "Someone threatened to hurt 10th grader at school" ,
"p_fight"  , "Got into a physical fight at school"              ,
"hit"      , "Someone hit 10th grader"                          ,
"damaged"  , "Someone damaged belongings"                       ,
"bullied"  , "Someone bullied or picked on 10th grader"         ,
"safe"     , "Does not feel safe at this school"                ,
"disrupt"  , "Disruptions get in way of learning"               ,
"gangs"    , "There are gangs in school"                        ,
"rac_fght" , "Racial groups often fight"                        ) %>% 
gt() %>% 
tab_header(
title = md("**Applied Example: School Trouble**"), subtitle = md("&nbsp;")) %>%
tab_source_note(source_note = md("Data Source: **Educational Longitudinal Study (ELS; 2002).**")) %>%
tab_row_group(group = "Factor 1", rows = 1:6) %>%
tab_row_group(group = "Factor 2", rows = 7:10) %>%
row_group_order(groups = c("Factor 1","Factor 2")) %>% 
tab_options(column_labels.font.weight = "bold")
```

## Make a simple CFA path diagram using package {`DiagrammeR`} 
```{r}

# Figure out how to add the covariance arrow

grViz(" digraph CFA_basic {
 
 node [shape=box]
 stolen t_hurt p_fight hit damaged bullied safe disrupt gangs rac_fght;
 
 node [shape=circle, width = 0.9]
 factor1 factor2;
 
 edge []
 factor1 -> {stolen t_hurt p_fight hit damaged bullied}
 factor2 -> {safe disrupt gangs rac_fght}
}")

```


## Estimate CFA model 
```{r, eval=FALSE}

# Note (Josh): Where should we store models & figures for reading back in? 
# I believe the combination of MplusAutomation + RProjects + here() is 
# important for organization purposes but may be hard to demonstrate in this context.

cfa_m0  <- mplusObject(
  TITLE = "CFA model0 - LAB 8 mimic models", 
  VARIABLE = 
    "usevar = stolen-rac_fght;", 
  
  ANALYSIS = 
    "estimator = mlr;",
  
  MODEL = 
    "factor1 by stolen t_hurt p_fight hit damaged bullied;
  
     factor2 BY safe disrupt gangs rac_fght;" ,
  
  PLOT = "type = plot3;",
  OUTPUT = "sampstat standardized residual modindices (3.84);",
  
  usevariables = colnames(mimic_data), 
  rdata = mimic_data)

cfa_m0_fit <- mplusModeler(cfa_m0, 
                            dataout=here("cfa_mplus", "cfa_data.dat"),
                            modelout=here("cfa_mplus", "cfa_model.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)
```

## Read in CFA model into R environment
```{r, eval=FALSE}

cfa_output <- readModels(here("cfa_mplus", "lab8_cfa_model0.out"))

```

## Create a path diagram with `semPlot` package
```{r, eval=FALSE}

semPaths(cfa_output)

```
